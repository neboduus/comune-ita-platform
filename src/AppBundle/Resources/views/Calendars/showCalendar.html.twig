{% extends '@App/Default/index.html.twig' %}

{% block stylesheets %}
  {{ encore_entry_link_tags('fullcalendar-manager') }}

  <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/4.2.0/core/main.min.css"/>
  <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/4.2.0/daygrid/main.min.css"/>
  <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/4.2.0/timegrid/main.min.css"/>
  <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/4.2.0/list/main.min.css"/>
  <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/4.2.0/bootstrap/main.min.css"/>
  <link rel="stylesheet" type="text/css" href="https://printjs-4de6.kxcdn.com/print.min.css"/>
{% endblock %}

{% block javascripts %}

  {{ encore_entry_script_tags('fullcalendar-manager') }}
  <script type="text/javascript"
          src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/4.2.0/core/main.min.js"></script>
  <script type="text/javascript"
          src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/4.2.0/daygrid/main.min.js"></script>
  <script type="text/javascript"
          src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/4.2.0/core/locales-all.min.js"></script>
  <script type="text/javascript"
          src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/4.2.0/timegrid/main.min.js"></script>
  <script type="text/javascript"
          src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/4.2.0/list/main.min.js"></script>
  <script type="text/javascript"
          src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/4.2.0/bootstrap/main.min.js"></script>
  <script type="text/javascript"
          src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/4.2.0/interaction/main.min.js"></script>
  <script type="text/javascript" src="https://printjs-4de6.kxcdn.com/print.min.js"></script>
<script>
  /**
   * Edits meeting by API request
   * @param btnId: button id to retrieve data
   * @param changeStatus: new status
   */
  function editEvent(btnId, changeStatus) {
    let status;
    if (changeStatus) status = changeStatus;
    else status = $('#modalStatus').html();

    let date = $('#modalDate').val();
    let slot = $('#modalSlot').val().split(' - ');
    let start = slot[0];
    let end = slot[1];
    let id = $('#modalId').html();

    if (!start || !end)
        return $('#modalError').html('<li><span class="badge badge-danger mr-2">Errore</span>Seleziona un orario valido</li>');

    let data = {
      status: status,
      from_time: new Date(`${date}T${start}`).toISOString(),
      to_time: new Date(`${date}T${end}`).toISOString(),
      email: $('#modalEmail').val(),
      phone_number: $('#modalPhone').val(),
      user_message: $('#modalDescription').val(),
      motivation_outcome: $('#modalMotivationOutcome').val(),
      videoconference_link: $('#modalVideoconferenceLink').val(),
      opening_hour: $('#modalOpeningHour').val()
    };
    let url = $(`#${btnId}`).attr('data-url');
    let token = $('#hidden').attr('data-token');
    url = url.replace("meeting_id", id);
    $.ajax({
      headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
      },
      url: url,
      type: 'PATCH',
      data: JSON.stringify(data),
      success: function (response, textStatus, jqXhr) {
        location.reload();
      },
      error: function (jqXHR, textStatus, errorThrown) {
        let error = jqXHR.responseJSON.description ? jqXHR.responseJSON.description : "Si è verificato un errore durante il salvataggio dell'appuntamento";
        let errorMessage = `<span class="badge badge-danger mr-2">Errore</span>${error}`
        $('#modalError').html(errorMessage);
      },
    });
  }


  /**
   * Deletes meeting by API request
   * @param btnId: button id to retrieve data
   */
  function deleteEvent(btnId) {
      let id = $('#modalDraftId').html();

      let url = $(`#${btnId}`).attr('data-url');
      let token = $('#hidden').attr('data-token');
      url = url.replace("meeting_id", id);
      $.ajax({
          headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
          },
          url: url,
          type: 'DELETE',
          success: function (response, textStatus, jqXhr) {
              location.reload();
          },
          error: function (jqXHR, textStatus, errorThrown) {
            let error = jqXHR.responseJSON.description ? jqXHR.responseJSON.description : "Si è verificato un errore durante il salvataggio dell'appuntamento";
            let errorMessage = `<span class="badge badge-danger mr-2">Errore</span>${error}`
            $('#modalDraftError').html(errorMessage);
          },
      });
  }

  /**
   * Creates a meeting by API request
   * @param btnId: button id to retrieve data
   * @param calendar: calendar id
   */
  function createMeeting(btnId, calendar) {
    let date = $('#modalNewDate').val();
    let slot = $('#modalNewSlot').val().split(' - ');
    let start = slot[0];
    let end = slot[1];

      if (!start || !end)
          return $('#modalNewError').html('<li><span class="badge badge-danger mr-2">Errore</span>Seleziona un orario valido</li>');

    let data = {
      status: 1,
      from_time: new Date(`${date}T${start}`).toISOString(),
      to_time: new Date(`${date}T${end}`).toISOString(),
      user_message: $('#modalNewDescription').val(),
      motivation_outcome: $('#modalNewMotivationOutcome').val(),
      fiscal_code: $('#modalNewFiscalCode').val(),
      videoconference_link: $('#modalNewVideoconferenceLink').val(),
      email: $('#modalNewEmail').val(),
      name: $('#modalNewName').val(),
      phone_number: $('#modalNewPhone').val(),
      calendar: calendar,
      opening_hour: $('#modalNewOpeningHour').val()
    };

    let url = $(`#${btnId}`).attr('data-url');
    let token = $('#hidden').attr('data-token');
    $.ajax({
      headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
      },
      url: url,
      type: 'POST',
      data: JSON.stringify(data),
      success: function (response, textStatus, jqXhr) {
        location.reload();
      },
      error: function (jqXHR, textStatus, errorThrown) {
        let error = jqXHR.responseJSON.description ? jqXHR.responseJSON.description : "Si è verificato un errore durante il salvataggio dell'appuntamento";
        let errorMessage = `<span class="badge badge-danger mr-2">Errore</span>${error}`
        $('#modalNewError').html(errorMessage);
      },
    });
  }
</script>

{% endblock %}

{% block main_content %}
  <section id="intro" class="container px-4 my-4">
    <div class="row">
      <div class="col-lg-12 px-lg-4 py-lg-2">
        <h1>{{ calendar.title }}</h1>
      </div>
    </div>
    {{ include('@App/Calendars/parts/tabs.twig') }}
    {{ include('@App/Calendars/parts/lastModified.html.twig') }}
    {{ include('@App/Calendars/parts/action_buttons.twig') }}
  </section>
{% endblock %}

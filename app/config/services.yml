# Learn more about services, parameters and containers at
# http://symfony.com/doc/current/book/service_container.html
parameters:
#    parameter_name: value

services:

  AppBundle\Controller\APIController:
    autowire: true

  AppBundle\Controller\Rest\ServicesAPIController:
    autowire: true

  AppBundle\Controller\Rest\ApplicationsAPIController:
    autowire: true

  AppBundle\Controller\Rest\CalendarsAPIController:
    autowire: true

  AppBundle\Controller\Rest\MeetingsAPIController:
    autowire: true

  AppBundle\Controller\Rest\SubscriptionServicesAPIController:
    autowire: true

  AppBundle\Controller\PraticheAnonimeController:
    autowire: true

  GuzzleHttp\Client: '@guzzle.client.mypay'

  AppBundle\Form\Scia\PraticaEdiliziaVincoliType:
    autowire: true
    tags:
      - { name: form.type }

  AppBundle\Form\OccupazioneSuoloPubblico\ImportoType:
    autowire: true
    tags:
      - { name: form.type }

  AppBundle\Form\OccupazioneSuoloPubblico\ImportoChecker:
    autowire: true

  AppBundle\Form\MeetingType:
    autowire: true
    tags:
       - { name: form.type }

  AppBundle\Services\MyPayService:
    autowire: true

  AppBundle\Payment\Gateway\Bollo:
    autowire: true

  AppBundle\Payment\Gateway\MyPay:
    autowire: true

  AppBundle\Validator\Constraints:
    autowire: true

  AppBundle\BackOffice\SubcriptionsBackOffice:
    autowire: true
    tags: ['app.backoffice']

  AppBundle\BackOffice\CalendarsBackOffice:
    autowire: true
    tags: ['app.backoffice']

  ocsdc.backoffices:
    class: AppBundle\Services\BackOfficeCollection
    arguments:
      - !tagged app.backoffice

  AppBundle\Controller\SubscriptionsController:
    autowire: true

  AppBundle\Controller\SubscriberController:
    autowire: true,
    arguments: ["@ocsdc.mailer", "%default_from_email_address%", "@logger"]

  Vich\UploaderBundle\Naming\DirectoryNamerInterface: "@ocsdc.allegati.directory_namer"

  ocsdc.cps.userprovider:
    class: AppBundle\Services\CPSUserProvider
    arguments: ["@doctrine.orm.default_entity_manager", "@logger"]

  ocsdc.cps.token_authenticator:
    class: AppBundle\Security\CPSAuthenticator

  ocsdc.cps.terms_acceptance_listener:
    class: AppBundle\EventListener\TermsAcceptListener
    arguments: ["@router", "@security.token_storage", "@ocsdc.cps.terms_acceptance_checker"]
    tags:
      - { name: kernel.event_listener, event: kernel.request, priority: -10 }

  ocsdc.cps.complete_profile_listener:
    class: AppBundle\EventListener\CompleteProfileListener
    arguments: ["@router","@security.token_storage", "@ocsdc.cps.userprovider", "%PasswordLifeTime%"]
    tags:
      - { name: kernel.event_listener, event: kernel.request, priority: -100 }

  gedmo.listener.sluggable:
    class: Gedmo\Sluggable\SluggableListener
    tags:
      - { name: doctrine.event_subscriber, connection: default }
    calls:
      - [ setAnnotationReader, [ "@annotation_reader" ] ]

  monolog_processor:
    class: Monolog\Processor\PsrLogMessageProcessor
    tags:
      - { name: monolog.processor }

  ocsdc.form.flow.type_extension.help_data:
    class: AppBundle\Form\Extension\HelpDataTypeExtension
    arguments: ["@translator", "%prefix%"]
    tags:
      - { name: form.type_extension, alias: "form", extended_type: Symfony\Component\Form\Extension\Core\Type\FormType }

  ocsdc.allegati.directory_namer:
    class: AppBundle\Services\DirectoryNamerService

  ocsdc.allegati.mimetype_validator:
    class: AppBundle\Validator\Constraints\ValidMimeTypeValidator
    arguments: ["@translator"]
    tags:
      - { name: validator.constraint_validator }

  ocsdc.mailer:
    class: AppBundle\Services\MailerService
    arguments: ["@mailer", "@translator", "@templating", "@doctrine"]


  ocsdc.modulo_pdf_builder:
    class: AppBundle\Services\ModuloPdfBuilderService
    arguments:
      - "@filesystem"
      - "@doctrine.orm.default_entity_manager"
      - "@translator"
      - "@vich_uploader.property_mapping_factory"
      - "@ocsdc.allegati.directory_namer"
      - "@knp_snappy.pdf"
      - "%wkhtmltopdf_service%"
      - "@templating"
      - "%ocsdc_default_datetime_format%"
      - "@router"


  ocsdc.protocollo.client: "@guzzle.client.protocollo_cct"

  ocsdc.protocollo.handler: "@ocsdc.protocollo.handlers.dummy"

  ocsdc.protocollo.handlers.dummy:
    class: AppBundle\Protocollo\DummyProtocolloHandler
    public: false

  ocsdc.protocollo.handlers.pitre:
    class: AppBundle\Protocollo\PiTreProtocolloHandler
    arguments: ["@ocsdc.protocollo.client", "%prefix%"]
    public: false

  ocsdc.protocollo.handlers.infor:
    class: AppBundle\Protocollo\InforProtocolloHandler
    autowire: true
    #        arguments: ["@doctrine.orm.entity_manager",'@logger', '@ocsdc.allegati.directory_namer',  '@vich_uploader.property_mapping_factory' ]
    public: false

  ocsdc.protocollo_delayed:
    class: AppBundle\Services\DelayedProtocolloService
    arguments: ["@ocsdc.protocollo_direct","@doctrine.orm.entity_manager","@logger", "@ocsdc.schedule_action_service"]

  ocsdc.protocollo_direct:
    class: AppBundle\Services\ProtocolloService
    arguments: ["@ocsdc.protocollo.handler","@doctrine.orm.entity_manager","@logger","@event_dispatcher"]

  ocsdc.protocollo: "@ocsdc.protocollo_delayed"

  ocsdc.pratica_listeners.sendmail:
    class: AppBundle\EventListener\SendMailPraticaListener
    arguments: ["@ocsdc.mailer", "%default_from_email_address%", "@logger"]
    tags:
      - { name: kernel.event_listener, event: ocsdc.pratica.on_status_change, method: onStatusChange, priority: 10 }

  ocsdc.pratica_listeners.backoffice:
    class: AppBundle\EventListener\BackOfficePraticaListener
    arguments: ["@service_container", "@logger"]
    tags:
      - { name: kernel.event_listener, event: ocsdc.pratica.on_status_change, method: onStatusChange, priority: 20 }

  ocsdc.pratica_listeners.protocollo:
    class: AppBundle\EventListener\ProtocollaPraticaListener
    arguments: ["@ocsdc.protocollo","@logger"]
    tags:
      - { name: kernel.event_listener, event: ocsdc.pratica.on_status_change, method: onStatusChange, priority: 100 }

  ocsdc.form.flow.storage_key_generator:
    class: AppBundle\Form\UserSessionStorageKeyGenerator

  ocsdc.form.type.choose_allegato:
    class: AppBundle\Form\Base\ChooseAllegatoType
    arguments: ["@doctrine.orm.entity_manager", "@validator"]
    tags:
      - { name: form.type }

  ocsdc.form.type.upload_allegato:
    class: AppBundle\Form\Base\UploadAllegatoType
    arguments: ["@doctrine.orm.entity_manager", "@validator"]
    tags:
      - { name: form.type }

  ocsdc.form.type.signed_allegato:
    class: AppBundle\Form\Operatore\Base\SignedAllegatoType
    arguments: ["@doctrine.orm.entity_manager", "@validator", "@ocsdc.p7m_signature_check"]
    tags:
      - { name: form.type }

  ocsdc.form.type.scia_edilizia_modulo_scia_pratica_edilizia_type:
    class: AppBundle\Form\Scia\PraticaEdiliziaModuloSciaType
    arguments: ["@doctrine.orm.entity_manager", "@validator", "@ocsdc.p7m_signature_check"]
    tags:
      - { name: form.type }

  ocsdc.form.type.scia_edilizia_allegati_modulo_scia_pratica_edilizia_type:
    class: AppBundle\Form\Scia\PraticaEdiliziaAllegatiModuloSciaType
    arguments: ["@doctrine.orm.entity_manager", "@validator", "@ocsdc.p7m_signature_check"]
    tags:
      - { name: form.type }

  ocsdc.form.type.scia_ediliza_soggetti_type:
    class: AppBundle\Form\Scia\PraticaEdiliziaSoggettiType
    arguments: ["@doctrine.orm.entity_manager", "@validator", "@ocsdc.p7m_signature_check"]
    tags:
      - { name: form.type }

  ocsdc.form.type.scia_edilizia_allegati_tecnici_type:
    class: AppBundle\Form\Scia\PraticaEdiliziaAllegatiTecniciType
    arguments: ["@doctrine.orm.entity_manager", "@validator", "@ocsdc.p7m_signature_check"]
    tags:
      - { name: form.type }

  ocsdc.form.type.scia_edilizia_ulteriori_allegati_tecnici_type:
    class: AppBundle\Form\Scia\PraticaEdiliziaUlterioriAllegatiTecniciType
    arguments: ["@doctrine.orm.entity_manager", "@validator", "@ocsdc.p7m_signature_check"]
    tags:
      - { name: form.type }

  ocsdc.form.type.scia_edilizia_provvedimenti_type:
    class: AppBundle\Form\Scia\PraticaEdiliziaProvvedimentiType
    arguments: ["@doctrine.orm.entity_manager", "@validator", "@ocsdc.p7m_signature_check"]
    tags:
      - { name: form.type }

  ocsdc.form.type.select_payment_gateway_type:
    class: AppBundle\Form\Base\SelectPaymentGatewayType
    autowire: true
    tags:
      - { name: form.type }

  AppBundle\Form\FormIO\FormIORenderType:
    autowire: true
    tags:
      - { name: form.type }

  AppBundle\Form\Admin\Servizio\FormIOBuilderRenderType:
    autowire: true
    tags:
      - { name: form.type }

  AppBundle\Form\Admin\Servizio\FormIOTemplateType:
    autowire: true
    tags:
      - { name: form.type }

  AppBundle\Form\Base\PaymentGatewayType:
    autowire: true
    tags:
      - { name: form.type }

  AppBundle\Form\Admin\Servizio\PaymentDataType:
    autowire: true
    tags:
      - { name: form.type }

  AppBundle\Form\Admin\Servizio\IntegrationsDataType:
    autowire: true
    tags:
      - { name: form.type }

  AppBundle\Form\Admin\Servizio\ProtocolDataType:
    autowire: true
    tags:
      - { name: form.type }

  AppBundle\Form\Admin\Ente\EnteType:
    autowire: true
    tags:
      - { name: form.type }

  AppBundle\Form\SubscriptionServiceType:
    autowire: true
    tags:
      - { name: form.type }

  AppBundle\Form\OperatoreUserType:
    autowire: true
    tags:
      - { name: form.type }

  AppBundle\Form\FormIO\FormIOAnonymousRenderType:
    autowire: true
    tags:
      - { name: form.type }

  ocsdc.form.type.payment_gateway_type: '@AppBundle\Form\Base\PaymentGatewayType'

  ocsdc.form.flow.pratica:
    class: AppBundle\Form\Base\PraticaFlow
    parent: craue.form.flow
    arguments:
      - "@logger"
      - "@translator"
      - "@ocsdc.pratica_status_service"
      - "@ocsdc.modulo_pdf_builder"
      - "@ocsdc.allegati.dematerialized_attacher"
      - "%prefix%"

  ocsdc.form.flow.asilonido:
    class: AppBundle\Form\IscrizioneAsiloNido\IscrizioneAsiloNidoFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.form.flow.autoletturaacqua:
    class: AppBundle\Form\AutoletturaAcqua\AutoletturaAcquaFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.form.flow.iscrizioneregistroassociazioni:
    class: AppBundle\Form\IscrizioneRegistroAssociazioni\IscrizioneRegistroAssociazioniFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.form.flow.contributopannolini:
    class: AppBundle\Form\ContributoPannolini\ContributoPannoliniFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.form.flow.cambioresidenza:
    class: AppBundle\Form\CambioResidenza\CambioResidenzaFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.form.flow.allacciamentoacquedotto:
    class: AppBundle\Form\AllacciamentoAcquedotto\AllacciamentoAcquedottoFlow
    parent: ocsdc.form.flow.pratica
    arguments: ["@logger","@translator"]

  ocsdc.form.flow.certificatonascita:
    class: AppBundle\Form\CertificatoNascita\CertificatoNascitaFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.form.flow.estrattonascita:
    class: AppBundle\Form\EstrattoNascita\EstrattoNascitaFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.form.flow.attonascita:
    class: AppBundle\Form\AttoNascita\AttoNascitaFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.form.flow.certificatomorte:
    class: AppBundle\Form\CertificatoMorte\CertificatoMorteFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.form.flow.estrattomorte:
    class: AppBundle\Form\EstrattoMorte\EstrattoMorteFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.form.flow.attomorte:
    class: AppBundle\Form\AttoMorte\AttoMorteFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.form.flow.certificatomatrimonio:
    class: AppBundle\Form\CertificatoMatrimonio\CertificatoMatrimonioFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.form.flow.estrattomatrimonio:
    class: AppBundle\Form\EstrattoMatrimonio\EstrattoMatrimonioFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.form.flow.attomatrimonio:
    class: AppBundle\Form\AttoMatrimonio\AttoMatrimonioFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.form.flow.nullaostamatrimonio:
    class: AppBundle\Form\CertificatoAnagrafico\CertificatoAnagraficoFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.form.flow.attestazioneanagrafica:
    class: AppBundle\Form\AttestazioneAnagrafica\AttestazioneAnagraficaFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.form.flow.listeelettorali:
    class: AppBundle\Form\ListeElettorali\ListeElettoraliFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.form.flow.statofamiglia:
    class: AppBundle\Form\StatoFamiglia\StatoFamigliaFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.form.flow.formio:
    class: AppBundle\Form\FormIO\FormIOFlow
    parent: ocsdc.form.flow.pratica

  # Inzio operatore

  ocsdc.form.flow.praticaoperatore:
    class: AppBundle\Form\Operatore\Base\PraticaOperatoreFlow
    parent: craue.form.flow
    arguments: ["@logger","@translator"]

  ocsdc.form.flow.standardoperatore:
    class: AppBundle\Form\Operatore\Standard\StandardOperatoreFlow
    parent: ocsdc.form.flow.praticaoperatore

  ocsdc.form.flow.operatore.standardallegatonofirma:
    class: AppBundle\Form\Operatore\Standard\StandardAllegatoNoFirmaFlow
    parent: ocsdc.form.flow.praticaoperatore

  ocsdc.form.flow.certificatonascitaoperatore:
    class: AppBundle\Form\Operatore\CertificatoNascita\CertificatoNascitaOperatoreFlow
    parent: ocsdc.form.flow.praticaoperatore

  ocsdc.form.flow.attestazioneanagraficaoperatore:
    class: AppBundle\Form\Operatore\AttestazioneAnagrafica\AttestazioneAnagraficaOperatoreFlow
    parent: ocsdc.form.flow.praticaoperatore

  ocsdc.form.flow.listeelettoralioperatore:
    class: AppBundle\Form\Operatore\ListeElettorali\ListeElettoraliOperatoreFlow
    parent: ocsdc.form.flow.praticaoperatore

  ocsdc.form.flow.statofamigliaoperatore:
    class: AppBundle\Form\Operatore\StatoFamiglia\StatoFamigliaOperatoreFlow
    parent: ocsdc.form.flow.praticaoperatore

  # Flow service servizio
  ocsdc.form.flow.service:
    class: AppBundle\Form\Admin\ServiceFlow
    parent: craue.form.flow
    arguments: ["@logger","@translator"]

  ocsdc.comunweb_content_provider:
    class: AppBundle\Services\ComunwebContentProviderService
    arguments: ["@guzzle.client.comunweb","@logger"]

  ocsdc.remote_content_provider: "@ocsdc.comunweb_content_provider"

  ocsdc.messages.client: "@guzzle.client.messages"
  ocsdc.messages_adapter:
    class: AppBundle\Services\MessagesAdapterService
    arguments: ["@ocsdc.messages.client", "@logger", "@doctrine", "%messages_enabled%"]

  ocsdc.twig.iter_calculator_extension:
    class: AppBundle\Twig\IterCalculatorExtension
    arguments: ['%ocsdc_iter_duration_start_status%', '%ocsdc_iter_duration_end_statuses%']
    public: false
    tags:
      - { name: twig.extension }

  ocsdc.twig.json_decode:
    class: AppBundle\Twig\JsonDecode
    tags:
      - { name: twig.extension }

  ocsdc.pratica_status_service:
    class: AppBundle\Services\PraticaStatusService
    arguments: ["@doctrine.orm.entity_manager", "@logger", "@event_dispatcher"]

  ocsdc.protocollo_success_events_subscriber:
    class: AppBundle\EventListener\ProtocolloSuccessSubscriber
    arguments: ["@ocsdc.pratica_status_service", "@logger"]
    tags:
      - { name: kernel.event_subscriber }

  ocsdc.user_security_subscriber:
    class: AppBundle\EventListener\UserSecuritySubscriber
    arguments: ["@fos_user.user_manager", "@router"]
    tags:
      - { name: kernel.event_subscriber }

  ocsdc.cps.terms_acceptance_checker:
    class: AppBundle\Services\TermsAcceptanceCheckerService
    arguments: ["@doctrine"]

  ocsdc.instance_service:
    class: AppBundle\Services\InstanceService
    arguments: ["@doctrine", "%prefix%"]

  ocsdc.form.flow.occupazionesuolopubblico:
    class: AppBundle\Form\OccupazioneSuoloPubblico\OccupazioneSuoloPubblicoFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.form.flow.scia_pratica_edilizia:
    class: AppBundle\Form\Scia\SciaPraticaEdiliziaFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.form.flow.contributoassociazioni:
    class: AppBundle\Form\ContributoAssociazioni\ContributoAssociazioniFlow
    parent: ocsdc.form.flow.pratica

  ocsdc.p7m_signature_check:
    class: AppBundle\Services\P7MSignatureCheckService

  ocsdc.p7m_thumbnailer_service:
    class: AppBundle\Services\P7MThumbnailerService
    arguments:
      - '@ocsdc.allegati.directory_namer'
      - '@vich_uploader.property_mapping_factory'
      - '@logger'
      - '%gsbinary%'

  ocsdc.validator.scia.at_least_one_attachment:
    class: AppBundle\Validator\Constraints\AtLeastOneAttachmentConstraintValidator
    arguments:
      - '@ocsdc.allegati.directory_namer'
      - '@vich_uploader.property_mapping_factory'
      - '@filesystem'
      - '@doctrine.orm.entity_manager'
    tags:
      - { name: 'validator.constraint_validator' }

  AppBundle\Validator\Constraints\AtLeastOneAttachmentConstraintValidator: '@ocsdc.validator.scia.at_least_one_attachment'

  ocsdc.giscom_api.adapter_direct:
    class: AppBundle\Services\GiscomAPIAdapterService
    arguments:
      - '@guzzle.client.giscom'
      - '@doctrine.orm.entity_manager'
      - '@logger'
      - '@ocsdc.giscom_api.mapper'
      - '@ocsdc.pratica_status_service'
      - "@ocsdc.status_mapper.giscom"

  ocsdc.giscom_api.adapter_delayed:
    class: AppBundle\Services\DelayedGiscomAPIAdapterService
    arguments:
      - '@ocsdc.giscom_api.adapter_direct'
      - '@doctrine.orm.entity_manager'
      - '@logger'
      - "@ocsdc.schedule_action_service"

  ocsdc.giscom_api.adapter: "@ocsdc.giscom_api.adapter_delayed"

  ocsdc.allegati.dematerialized_attacher:
    class: AppBundle\Services\DematerializedFormAllegatiAttacherService
    arguments:
      - '@doctrine.orm.entity_manager'

  ocsdc.protocollo_success_giscom_subscriber:
    class: AppBundle\EventListener\GiscomSendPraticaListener
    arguments: ["@ocsdc.giscom_api.adapter", "@logger"]
    tags:
      - { name: kernel.event_subscriber }

  ocsdc.schedule_action_service:
    class: AppBundle\Services\ScheduleActionService
    arguments: ["@doctrine.orm.entity_manager","@logger"]

  ocsdc.giscom_api.mapper:
    class: AppBundle\Services\GiscomAPIMapperService
    arguments:
      - '@doctrine.orm.entity_manager'

  ocsdc.status_mapper.giscom:
    class: AppBundle\Mapper\Giscom\GiscomStatusMapper
    tags:
      - { name: 'ocsdc.status_mapper' }

  ocsdc.pratica_integration_service:
    class: AppBundle\Services\PraticaIntegrationService
    arguments:
      - '@doctrine.orm.entity_manager'
      - '@logger'
      - '@ocsdc.pratica_status_service'
      - "@ocsdc.modulo_pdf_builder"

  ocsdc.formserver:
    class: AppBundle\Services\FormServerApiAdapterService
    arguments: ["%formserver_private_url%", "@logger"]

  # Handlers servizi
  ocsdc.handlers.servizio.imis:
    class: AppBundle\Handlers\Servizio\ImisHandler
    arguments: ["@security.token_storage", "@logger"]
